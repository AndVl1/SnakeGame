name: Merge Develop to Main

on:
  workflow_dispatch:
    inputs:
      trigger:
        description: '–¢—Ä–∏–≥–≥–µ—Ä –¥–ª—è –∑–∞–ø—É—Å–∫–∞'
        required: true
        default: 'manual'
        type: string

jobs:
  merge:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Configure Git
      run: |
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
    
    - name: Get commits to merge
      id: get-commits
      run: |
        git fetch origin develop main
        
        # –ù–∞—Ö–æ–¥–∏–º –æ–±—â–∏–π –±–∞–∑–æ–≤—ã–π –∫–æ–º–º–∏—Ç –º–µ–∂–¥—É main –∏ develop
        BASE_COMMIT=$(git merge-base origin/main origin/develop)
        echo "Base commit: $BASE_COMMIT"
        
        # –ü–æ–ª—É—á–∞–µ–º –∫–æ–º–º–∏—Ç—ã –æ—Ç –±–∞–∑–æ–≤–æ–≥–æ –¥–æ develop
        COMMITS=$(git log --pretty=format:"- %s" $BASE_COMMIT..origin/develop)
        echo "COMMITS<<EOF" >> $GITHUB_OUTPUT
        echo "$COMMITS" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Check for changes
      id: check-changes
      run: |
        git fetch origin develop main
        
        # –ù–∞—Ö–æ–¥–∏–º –æ–±—â–∏–π –±–∞–∑–æ–≤—ã–π –∫–æ–º–º–∏—Ç –º–µ–∂–¥—É main –∏ develop
        BASE_COMMIT=$(git merge-base origin/main origin/develop)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–º–∏—Ç–æ–≤ –æ—Ç –±–∞–∑–æ–≤–æ–≥–æ –¥–æ develop
        COMMITS_COUNT=$(git rev-list --count $BASE_COMMIT..origin/develop)
        if [ "$COMMITS_COUNT" -eq "0" ]; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "‚ùå –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Å–ª–∏—è–Ω–∏—è –∏–∑ develop –≤ main"
          exit 1
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "‚úÖ –ù–∞–π–¥–µ–Ω–æ $COMMITS_COUNT –Ω–æ–≤—ã—Ö –∫–æ–º–º–∏—Ç–æ–≤ –¥–ª—è —Å–ª–∏—è–Ω–∏—è"
          
          # –í—ã–≤–æ–¥–∏–º —Å–ø–∏—Å–æ–∫ –∫–æ–º–º–∏—Ç–æ–≤ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏
          echo "–ö–æ–º–º–∏—Ç—ã –¥–ª—è —Å–ª–∏—è–Ω–∏—è:"
          git log --pretty=format:"- %h %s" $BASE_COMMIT..origin/develop
        fi
    
    - name: Check existing PR
      id: check-pr
      if: steps.check-changes.outputs.has_changes == 'true'
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π PR —á–µ—Ä–µ–∑ GitHub API
        PR_DATA=$(curl -s -H "Authorization: token ${{ github.token }}" \
          "https://api.github.com/repos/${{ github.repository }}/pulls?head=${{ github.repository_owner }}:release/develop-to-main&state=open")
        
        PR_NUMBER=$(echo "$PR_DATA" | jq -r '.[0].number // empty')
        if [ ! -z "$PR_NUMBER" ]; then
          echo "existing_pr=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "‚úÖ –ù–∞–π–¥–µ–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π PR #$PR_NUMBER"
        else
          echo "existing_pr=0" >> $GITHUB_OUTPUT
          echo "‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π PR –Ω–µ –Ω–∞–π–¥–µ–Ω"
        fi

    - name: Close existing PR
      if: steps.check-pr.outputs.existing_pr != '0'
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π PR —á–µ—Ä–µ–∑ GitHub API
        curl -X PATCH \
          -H "Authorization: token ${{ github.token }}" \
          -H "Accept: application/vnd.github.v3+json" \
          -d '{"state":"closed"}' \
          "https://api.github.com/repos/${{ github.repository }}/pulls/${{ steps.check-pr.outputs.existing_pr }}"
        
        # –£–¥–∞–ª—è–µ–º –≤–µ—Ç–∫—É —á–µ—Ä–µ–∑ GitHub API
        curl -X DELETE \
          -H "Authorization: token ${{ github.token }}" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/${{ github.repository }}/git/refs/heads/release/develop-to-main"
        
        echo "‚úÖ –ó–∞–∫—Ä—ã—Ç PR #${{ steps.check-pr.outputs.existing_pr }} –∏ —É–¥–∞–ª–µ–Ω–∞ –≤–µ—Ç–∫–∞"
    
    - name: Create release branch
      if: steps.check-changes.outputs.has_changes == 'true'
      run: |
        git checkout develop
        git pull origin develop
        git checkout -b release/develop-to-main
        git push origin release/develop-to-main --force
    
    - name: Create Pull Request
      if: steps.check-changes.outputs.has_changes == 'true'
      id: create-pr
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        gh pr create \
          --title "Merge develop into main" \
          --body "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ PR –¥–ª—è —Å–ª–∏—è–Ω–∏—è –≤–µ—Ç–∫–∏ develop –≤ main \

          –°–æ–∑–¥–∞–Ω–æ —á–µ—Ä–µ–∑ GitHub Actions \

          ## –ö–æ–º–º–∏—Ç—ã –¥–ª—è —Å–ª–∏—è–Ω–∏—è: \

          ${{ steps.get-commits.outputs.COMMITS }}" \
          --base main \
          --head release/develop-to-main

        PR_URL=$(gh pr view --json url -q .url)
        echo "PR_URL=$PR_URL" >> $GITHUB_OUTPUT

    - name: Notify Telegram
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TG_CHAT }}
        token: ${{ secrets.TG_KEY }}
        message: |
          üîÑ –ó–∞–ø—É—â–µ–Ω –ø—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ä–µ–ª–∏–∑–∞

          –°–æ–∑–¥–∞–Ω Pull Request –∏–∑ –≤–µ—Ç–∫–∏ develop –≤ main

          –°—Å—ã–ª–∫–∞ –Ω–∞ PR: ${{ steps.create-pr.outputs.PR_URL }}

          –û–∂–∏–¥–∞–π—Ç–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ PR...

    - name: Notify Error to Telegram
      if: failure()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TG_CHAT }}
        token: ${{ secrets.TG_KEY }}
        message: |
          ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–µ–ª–∏–∑–∞
          
          –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å Pull Request –∏–∑ develop –≤ main
          
          –°—Å—ã–ª–∫–∞ –Ω–∞ –∫–æ–º–º–∏—Ç: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}
          –°—Å—ã–ª–∫–∞ –Ω–∞ –∑–∞—Ñ–µ–π–ª–µ–Ω–Ω—ã–π —ç–∫—à–Ω: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –∏ –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫—É. 
