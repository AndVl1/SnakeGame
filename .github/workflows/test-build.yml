name: Test Build

on:
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å GitHub
  push:
    branches:
      - 'feature/**'
      - 'bugfix/**' 
      - 'hotfix/**'
  pull_request:
    types: [opened, synchronize, reopened]
    branches-ignore:
      - 'master'
      - 'main'
      - 'develop'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Å–±–æ—Ä–∫–∏
    - name: Set build start time
      id: build-time-start
      run: echo "BUILD_START=$(date +%s)" >> $GITHUB_OUTPUT
    
    - name: Generate build number
      id: buildnumber
      uses: onyxmueller/build-tag-number@v1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        prefix: 'test'
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
    
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Android SDK Build Tools
    - name: Setup Android SDK
      uses: android-actions/setup-android@v2
#      with:
#        cmdline-tools-version: '8.0'
#        packages: 'build-tools;33.0.0,build-tools;30.0.3,platforms;android-35'

    # –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ Gradle Wrapper
    - name: Cache Gradle Wrapper
      uses: actions/cache@v3
      with:
        path: ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-wrapper-${{ hashFiles('gradle/wrapper/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-wrapper-
    
    # –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Gradle
    - name: Cache Gradle dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/daemon
          ~/.gradle/native
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
    
    # –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ Maven —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
    - name: Cache Maven repository
      uses: actions/cache@v3
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/build.gradle*') }}
        restore-keys: |
          ${{ runner.os }}-maven-
    
    # –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ Android SDK
    - name: Cache Android SDK
      uses: actions/cache@v3
      with:
        path: |
          ${{ env.ANDROID_HOME }}
          ~/.android/cache
        key: ${{ runner.os }}-android-sdk-${{ hashFiles('**/build.gradle*') }}
        restore-keys: |
          ${{ runner.os }}-android-sdk-
    
    # –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å–±–æ—Ä–∫–∏
    - name: Cache Build results
      uses: actions/cache@v3
      with:
        path: app/build
        key: ${{ runner.os }}-app-build-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-app-build-
    
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è —Ç–µ—Å—Ç–æ–≤–æ–π —Å–±–æ—Ä–∫–∏
    - name: Set test version info
      id: version
      run: |
        BRANCH_NAME=$(git branch --show-current)
        COMMIT_HASH=$(git rev-parse --short HEAD)
        TEST_VERSION="test-${BRANCH_NAME}-${COMMIT_HASH}-build.${{ steps.buildnumber.outputs.build_number }}"
        echo "Test –≤–µ—Ä—Å–∏—è: $TEST_VERSION"
        echo "TEST_VERSION=$TEST_VERSION" >> $GITHUB_OUTPUT
    
    # –°–æ–±–∏—Ä–∞–µ–º debug-–≤–µ—Ä—Å–∏—é —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è–º–∏
    - name: Build debug APK
      run: ./gradlew assembleDebug --build-cache --parallel --no-daemon
    
    # –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º debug APK
    - name: Sign Debug APK
      id: sign_debug_apk
      uses: r0adkll/sign-android-release@v1
      env:
        BUILD_TOOLS_VERSION: "33.0.0"
      with:
        releaseDirectory: app/build/outputs/apk/debug
        signingKeyBase64: ${{ secrets.RELEASE_KEYSTORE_BASE64 }}
        alias: ${{ secrets.KEY_ALIAS }}
        keyStorePassword: ${{ secrets.KEYSTORE_PASSWORD }}
        keyPassword: ${{ secrets.KEY_PASSWORD }}
    
    # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º APK —Ñ–∞–π–ª, –¥–æ–±–∞–≤–ª—è—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–µ—Ä—Å–∏–∏
    - name: Rename APK file
      run: |
        mkdir -p renamed_apk
        cp ${{ steps.sign_debug_apk.outputs.signedReleaseFile }} renamed_apk/app-debug-signed-${{ steps.version.outputs.TEST_VERSION }}.apk
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π debug APK
    - name: Upload Signed Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: app-debug-signed-${{ steps.version.outputs.TEST_VERSION }}
        path: renamed_apk/app-debug-signed-${{ steps.version.outputs.TEST_VERSION }}.apk
        retention-days: 7
        if-no-files-found: error
        overwrite: true
        compression-level: 0
        content-type: application/vnd.android.package-archive
    
    # –†–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ —Å–±–æ—Ä–∫–∏
    - name: Calculate build time
      id: build-time
      run: |
        END_TIME=$(date +%s)
        START_TIME=${{ steps.build-time-start.outputs.BUILD_START }}
        DURATION=$((END_TIME - START_TIME))
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è –≤ –º–∏–Ω—É—Ç—ã –∏ —Å–µ–∫—É–Ω–¥—ã
        MINUTES=$((DURATION / 60))
        SECONDS=$((DURATION % 60))
        
        if [ $MINUTES -gt 0 ]; then
          BUILD_TIME="${MINUTES}–º ${SECONDS}—Å"
        else
          BUILD_TIME="${SECONDS}—Å"
        fi
        
        echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT
        
    # –ü—É–±–ª–∏–∫—É–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ —Å–±–æ—Ä–∫–∏
    - name: Add build summary
      run: |
        echo "### üöÄ –¢–µ—Å—Ç–æ–≤–∞—è —Å–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞" >> $GITHUB_STEP_SUMMARY
        echo "**–í–µ—Ä—Å–∏—è:** ${{ steps.version.outputs.TEST_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "**–í—Ä–µ–º—è —Å–±–æ—Ä–∫–∏:** ${{ steps.build-time.outputs.build_time }}" >> $GITHUB_STEP_SUMMARY
        echo "**–ê—Ä—Ç–µ—Ñ–∞–∫—Ç:** app-debug-signed-${{ steps.version.outputs.TEST_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Commit SHA:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "**Runid:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ PR, –µ—Å–ª–∏ —Å–±–æ—Ä–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞ —á–µ—Ä–µ–∑ PR
    - name: Find Comment
      if: github.event_name == 'pull_request'
      uses: peter-evans/find-comment@v2
      id: fc
      with:
        issue-number: ${{ github.event.pull_request.number }}
        comment-author: 'github-actions[bot]'
        body-includes: Test Build

    - name: Create or update comment with APK link
      if: github.event_name == 'pull_request'
      uses: peter-evans/create-or-update-comment@v2
      with:
        comment-id: ${{ steps.fc.outputs.comment-id }}
        issue-number: ${{ github.event.pull_request.number }}
        body: |
          ### üöÄ Test Build –¥–ª—è PR
          
          –¢–µ—Å—Ç–æ–≤–∞—è —Å–±–æ—Ä–∫–∞ **${{ steps.version.outputs.TEST_VERSION }}** –≥–æ—Ç–æ–≤–∞ ‚úÖ
          
          [–°–∫–∞—á–∞—Ç—å –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π Debug APK](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          *–ê—Ä—Ç–µ—Ñ–∞–∫—Ç: `app-debug-signed-${{ steps.version.outputs.TEST_VERSION }}`*
          
          **–í—Ä–µ–º—è —Å–±–æ—Ä–∫–∏:** ${{ steps.build-time.outputs.build_time }}
        edit-mode: replace
        reactions: rocket
    
    # –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–µ–π –≤ —Ä–µ–¥–∫–∏—Ö —Å–ª—É—á–∞—è—Ö
    - name: Cleanup Gradle Cache
      # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ —É—Å–ª–æ–≤–∏—é, –Ω–∞–ø—Ä–∏–º–µ—Ä, –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ
      if: github.event_name == 'schedule' && github.event.schedule == '0 0 * * 0'
      run: |
        rm -rf ~/.gradle/caches/modules-2/modules-2.lock
        rm -rf ~/.gradle/caches/transforms-1
        rm -rf ~/.gradle/caches/journal-1
        rm -rf ~/.gradle/caches/jars-3 
