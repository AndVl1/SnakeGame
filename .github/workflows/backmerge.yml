name: Create Backmerge PR

on:
  push:
    branches:
      - main

jobs:
  create-backmerge-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: develop

      - name: Create backmerge branch
        run: |
          # –°–æ–∑–¥–∞–µ–º –≤–µ—Ç–∫—É –¥–ª—è –±—ç–∫–º–µ—Ä–∂–∞
          git checkout -b backmerge/main-to-develop
          
          # –ú–µ—Ä–∂–∏–º main –≤ develop
          git merge main --no-ff -m "Merge main into develop"
          
          # –ü—É—à–∏–º –≤–µ—Ç–∫—É
          git push origin backmerge/main-to-develop

      - name: Get commits to merge
        id: get-commits
        run: |
          git fetch origin main develop
          COMMITS=$(git log --pretty=format:"- %s" origin/develop..origin/main)
          echo "COMMITS<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        id: create-pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr create \
            --title "Backmerge: main ‚Üí develop" \
            --body "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±—ç–∫–º–µ—Ä–∂ main –≤ develop \

            –°–æ–∑–¥–∞–Ω–æ —á–µ—Ä–µ–∑ GitHub Actions \

            ## –ö–æ–º–º–∏—Ç—ã –¥–ª—è —Å–ª–∏—è–Ω–∏—è: \

            ${{ steps.get-commits.outputs.COMMITS }} \

            ## –ú–µ—Ç–∫–∏: \

            - backmerge \

            - automated" \
            --base develop \
            --head backmerge/main-to-develop \
            --label "backmerge,automated" \
            --assignee "${{ github.actor }}"
          
          PR_URL=$(gh pr view --json url -q .url)
          echo "PR_URL=$PR_URL" >> $GITHUB_OUTPUT

      - name: Notify Telegram
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TG_CHAT }}
          token: ${{ secrets.TG_KEY }}
          message: |
            üîÑ –°–æ–∑–¥–∞–Ω PR –¥–ª—è –±—ç–∫–º–µ—Ä–∂–∞ main –≤ develop
            
            –°—Å—ã–ª–∫–∞ –Ω–∞ PR: ${{ steps.create-pr.outputs.PR_URL }}
            
            –û–∂–∏–¥–∞–π—Ç–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ PR...

      - name: Notify Error to Telegram
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TG_CHAT }}
          token: ${{ secrets.TG_KEY }}
          message: |
            ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±—ç–∫–º–µ—Ä–∂–∞
            
            –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å Pull Request –∏–∑ main –≤ develop
            
            –°—Å—ã–ª–∫–∞ –Ω–∞ –∫–æ–º–º–∏—Ç: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}
            –°—Å—ã–ª–∫–∞ –Ω–∞ –∑–∞—Ñ–µ–π–ª–µ–Ω–Ω—ã–π —ç–∫—à–Ω: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –∏ –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫—É. 
